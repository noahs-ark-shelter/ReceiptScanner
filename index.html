<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
      /* --- CSS from receipt-scanner-css-v3 --- */
      /* --- Base Styles & Font Import --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
           scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            background-color: #eef2f7;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        /* --- Main Container --- */
        .container {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 550px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        /* --- Header --- */
        header h1 {
            color: #1e293b;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        header p {
            color: #475569;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        /* --- Section Handling & Transitions --- */
        .hidden-section {
            display: none;
        }

        .active-section {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Camera Viewfinder --- */
        .camera-viewfinder {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin: 25px auto;
            overflow: hidden;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            background-color: #1e293b;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        #camera-feed {
            display: block;
            width: 100%;
            height: auto;
        }

        .camera-viewfinder .overlay {
            position: absolute;
            top: 5%;
            left: 5%;
            right: 5%;
            bottom: 5%;
            border: 3px dashed rgba(255, 255, 255, 0.6);
            border-radius: 5px;
            pointer-events: none;
            box-shadow: 0 0 0 999px rgba(0, 0, 0, 0.4);
        }

        /* --- Button Styling (General) --- */
        .btn {
            display: inline-block;
            padding: 12px 28px;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin: 10px 5px;
            vertical-align: middle;
            text-decoration: none;
            color: white;
            letter-spacing: 0.5px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .btn:disabled {
            background-color: #cbd5e1 !important;
            background-image: none !important;
            box-shadow: none !important;
            cursor: not-allowed;
            opacity: 0.6;
            color: #64748b !important;
        }

        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:not(:disabled):active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        /* Specific Button Colors & Styles */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover:not(:disabled) {
             box-shadow: 0 6px 14px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #f1f5f9;
            border-color: #94a3b8;
            color: #1e293b;
            transform: translateY(0);
            box-shadow: none;
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #22d3ee 100%);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }
        .btn-info:hover:not(:disabled) {
             box-shadow: 0 6px 14px rgba(14, 165, 233, 0.4);
        }

        .scan-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .btn-capture {
            background-color: #ef4444;
            color: white;
            padding: 0;
            border-radius: 50%;
            width: 75px;
            height: 75px;
            font-size: 0;
            line-height: 75px;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
            border: 5px solid white;
            outline: 3px solid rgba(0, 0, 0, 0.05);
            outline-offset: 4px;
            flex-shrink: 0;
        }
        .btn-capture:hover:not(:disabled) {
            background-color: #dc2626;
             box-shadow: 0 6px 14px rgba(239, 68, 68, 0.4);
        }

        /* --- Form Styling --- */
        #review-section h2 {
            margin-bottom: 25px;
            color: #1e293b;
            font-weight: 600;
        }

        .captured-image-preview {
            position: relative;
            max-width: 90%;
            margin: 0 auto 25px auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        #image-preview {
            display: block;
            max-width: 100%;
            height: auto;
            border-radius: 7px;
        }

        .form-group {
            margin-bottom: 18px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #475569;
            font-size: 0.9rem;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            color: #334155;
            background-color: #f8fafc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        /* Style for date input placeholder */
        .form-group input[type="date"]:invalid {
            color: #94a3b8;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4f46e5;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }

        .form-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
        }
        .form-actions .btn {
            margin: 8px;
        }

        /* --- Status Message Styling --- */
        .status {
            margin: 25px auto 0 auto;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            visibility: hidden;
            max-width: 90%;
            border-width: 1px;
            border-style: solid;
            line-height: 1.4;
        }
        .status.visible {
            opacity: 1;
            visibility: visible;
        }

        #status-text {
            margin-bottom: 5px;
        }

        .status.success {
            background-color: #dcfce7;
            color: #166534;
            border-color: #a7f3d0;
        }

        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #fecaca;
        }

        .status.processing {
            background-color: #e0f2fe;
            color: #075985;
            border-color: #bae6fd;
        }

        .status.processing::before {
        }

        /* OCR Progress Bar */
        #ocr-progress-container {
            width: 80%;
            margin-top: 8px;
            display: none;
        }
        #ocr-progress-bar {
            height: 8px;
            background-color: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        #ocr-progress-bar-inner {
            width: 0%;
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.1s linear;
        }
        .status.processing #ocr-progress-container {
            display: block;
        }


        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Link & Footer --- */
        .sheet-link {
            margin-top: 30px;
        }
        .sheet-link a {
            color: #4f46e5;
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            padding: 8px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .sheet-link a:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
            color: #3730a3;
            text-decoration: none;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.85em;
            color: #64748b;
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px 25px;
            }
            header h1 {
                font-size: 1.6rem;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
             .btn-capture {
                width: 65px;
                height: 65px;
                line-height: 55px;
                border-width: 4px;
                outline-offset: 3px;
            }
            .form-actions .btn {
                margin: 6px;
                width: calc(50% - 12px);
                min-width: 120px;
            }
            .form-actions {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 400px) {
             .form-actions .btn {
                width: 100%;
                margin: 5px 0;
            }
             .scan-actions {
                gap: 10px;
            }
             .btn-capture {
                width: 60px;
                height: 60px;
                line-height: 50px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Receipt Scanner</h1>
        </header>

        <main>
            <section id="start-section" class="active-section">
                <p>Scan your receipt using your device's camera and save the details.</p>
                <button id="start-scan-btn" class="btn btn-primary">Start Scanning</button>
            </section>

            <section id="scan-section" class="hidden-section">
                <div class="camera-viewfinder">
                    <video id="camera-feed" playsinline aria-label="Live camera feed"></video>
                    <canvas id="capture-canvas" style="display: none;"></canvas>
                    <div class="overlay" aria-hidden="true"></div>
                </div>
                <div class="scan-actions">
                    <button id="capture-btn" class="btn btn-capture" title="Capture Image" aria-label="Capture Receipt Image"></button>
                    <button id="cancel-scan-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </section>

            <section id="review-section" class="hidden-section">
                <h2>Review Details</h2>
                <div class="captured-image-preview">
                    <img id="image-preview" src="#" alt="Captured Receipt Preview"/>
                    <a id="download-link" style="display: none;" aria-hidden="true"></a>
                </div>
                <form id="receipt-form" aria-labelledby="review-heading">
                    <h2 id="review-heading" class="hidden-section">Receipt Details Form</h2>
                    <div class="form-group">
                        <label for="vendor">Vendor:</label>
                        <input type="text" id="vendor" name="vendor" required placeholder="e.g., Store Name">
                    </div>
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount ($):</label>
                        <input type="number" step="0.01" id="amount" name="amount" required placeholder="e.g., 12.99">
                    </div>
                    <div class="form-group">
                        <label for="category">Category (Optional):</label>
                        <input type="text" id="category" name="category" placeholder="e.g., Groceries, Gas">
                    </div>
                    <div class="form-actions">
                        <button type="submit" id="save-btn" class="btn btn-primary">Save to Sheet</button>
                        <button type="button" id="rescan-btn" class="btn btn-secondary">Scan Again</button>
                        <button type="button" id="download-btn" class="btn btn-info">Download Receipt</button>
                    </div>
                </form>
            </section>

            <div id="status-message" class="status" role="alert" aria-live="polite">
                <span id="status-text"></span>
                <div id="ocr-progress-container">
                    <div id="ocr-progress-bar">
                        <div id="ocr-progress-bar-inner"></div>
                    </div>
                </div>
            </div>

            <div class="sheet-link">
                <a id="view-sheet-link" href="https://docs.google.com/spreadsheets/d/1E35ohp5fFhaF5Mm4cY_-xdH3HLYQNc7toZfnG5d9lNQ/edit?gid=0#gid=0" target="_blank" style="display: inline-block;">View Google Sheet</a>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Receipt Scanner App</p>
        </footer>
    </div>

    <script>
        // Wait for the DOM to be fully loaded before running script
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            // ######################################################################
            // ###          PASTE YOUR WEB APP URL HERE                    ###
            // ######################################################################
            // Get this URL after deploying the Google Apps Script as a Web App.
            // Saving to Google Sheets will NOT work if this is not replaced.
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyHCV2Sj4xYCHFr4W4_ql6l4te-tC1Jbappq0OYnCSXKErPPGElKqQFTjaTxSUop_Ba/exec';
            // ######################################################################

            // --- Optional Configuration ---
            // Replace with your Google Sheet URL if you want the "View Sheet" link to work
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1E35ohp5fFhaF5Mm4cY_-xdH3HLYQNc7toZfnG5d9lNQ/edit?gid=0#gid=0';
            // Image quality for JPEG conversion (0.0 to 1.0)
            const IMAGE_QUALITY = 0.90;


            // --- Get references to HTML elements ---
            // Sections
            const startSection = document.getElementById('start-section');
            const scanSection = document.getElementById('scan-section');
            const reviewSection = document.getElementById('review-section');
            // Buttons
            const startScanBtn = document.getElementById('start-scan-btn');
            const cancelScanBtn = document.getElementById('cancel-scan-btn');
            const captureBtn = document.getElementById('capture-btn');
            const rescanBtn = document.getElementById('rescan-btn');
            const saveBtn = document.getElementById('save-btn');
            const downloadBtn = document.getElementById('download-btn');
            // Media & Display
            const videoElement = document.getElementById('camera-feed');
            const canvasElement = document.getElementById('capture-canvas');
            const imagePreview = document.getElementById('image-preview');
            const downloadLink = document.getElementById('download-link');
            // Form & Inputs
            const receiptForm = document.getElementById('receipt-form');
            const vendorInput = document.getElementById('vendor');
            const dateInput = document.getElementById('date');
            const amountInput = document.getElementById('amount');
            // Status & Feedback
            const statusMessage = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');
            const ocrProgressContainer = document.getElementById('ocr-progress-container');
            const ocrProgressBar = document.getElementById('ocr-progress-bar-inner');
            const viewSheetLink = document.getElementById('view-sheet-link');

            // --- State Variables ---
            let currentStream = null;
            let capturedImageDataURL = null;
            let ocrWorker = null;
            let isProcessing = false;

            // --- Initial Setup ---
            if (GOOGLE_SHEET_URL && GOOGLE_SHEET_URL !== 'YOUR_GOOGLE_SHEET_LINK_HERE') {
                viewSheetLink.href = GOOGLE_SHEET_URL;
                viewSheetLink.style.display = 'inline-block';
            }
            try {
                dateInput.value = new Date().toISOString().split('T')[0];
            } catch(e) { console.error("Could not set default date", e);}


            // --- Event Listeners ---
            startScanBtn.addEventListener('click', () => {
                if (isProcessing) return;
                switchSection('scan');
                startCamera();
            });
            cancelScanBtn.addEventListener('click', () => {
                if (isProcessing) return;
                stopCamera();
                switchSection('start');
            });
            captureBtn.addEventListener('click', async () => {
                if (isProcessing) return;
                isProcessing = true;
                captureBtn.disabled = true;
                cancelScanBtn.disabled = true;
                captureImage();
                if (capturedImageDataURL) {
                    stopCamera();
                    switchSection('review');
                    await performOCR(capturedImageDataURL);
                } else {
                    captureBtn.disabled = false;
                    cancelScanBtn.disabled = false;
                }
                isProcessing = false;
            });
            rescanBtn.addEventListener('click', () => {
                if (isProcessing) return;
                resetReviewState();
                switchSection('scan');
                startCamera();
            });
            downloadBtn.addEventListener('click', () => {
                if (isProcessing || !capturedImageDataURL) return;
                downloadLink.href = capturedImageDataURL;
                const timestamp = new Date();
                const filename = `receipt-${timestamp.getFullYear()}${String(timestamp.getMonth() + 1).padStart(2, '0')}${String(timestamp.getDate()).padStart(2, '0')}_${String(timestamp.getHours()).padStart(2, '0')}${String(timestamp.getMinutes()).padStart(2, '0')}${String(timestamp.getSeconds()).padStart(2, '0')}.jpg`;
                downloadLink.download = filename;
                downloadLink.click();
                showStatus("Receipt downloaded.", "success", 3000);
            });
            receiptForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (isProcessing || !capturedImageDataURL) return;
                 if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'https://script.google.com/macros/s/AKfycbyHCV2Sj4xYCHFr4W4_ql6l4te-tC1Jbappq0OYnCSXKErPPGElKqQFTjaTxSUop_Ba/exec') {
                    showStatus("Configuration Error:Google Apps Script URL is not set.", "error", 6000);
                    return;
                }
                isProcessing = true;
                setReviewButtonsState(false);
                showStatus("Saving to Google Sheet...", "processing", 0);
                const formData = new FormData(receiptForm);
                const dataToSend = {
                    imageData: capturedImageDataURL,
                    vendor: formData.get('vendor'),
                    date: formData.get('date'),
                    amount: formData.get('amount'),
                    category: formData.get('category') || '',
                    filename: `receipt-${new Date().toISOString()}.jpg`
                };
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToSend),
                    });
                    if (!response.ok && response.type !== 'opaque') {
                        const errorText = await response.text();
                        throw new Error(`Network error: ${response.status} ${response.statusText}. Response: ${errorText}`);
                    }
                    let data;
                    if (response.type === 'opaque') {
                        console.warn("Received opaque response from Apps Script. Assuming success.");
                        data = { status: 'success', message: 'Receipt likely saved (opaque response).' };
                    } else {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            data = await response.json();
                        } else {
                            const textResponse = await response.text();
                            console.warn("Received non-JSON response:", textResponse);
                            data = { status: 'success', message: 'Receipt saved (non-JSON response received).' };
                        }
                    }
                    console.log('Response from Apps Script:', data);
                    if (data.status === 'success') {
                        showStatus(data.message || "Receipt saved successfully!", "success", 4000);
                        resetReviewState();
                    } else {
                        throw new Error(data.message || "Unknown error reported by Apps Script.");
                    }
                } catch (error) {
                    console.error('Error sending data to Apps Script:', error);
                    showStatus(`Error saving receipt: ${error.message}`, "error", 8000);
                } finally {
                    setReviewButtonsState(true);
                    isProcessing = false;
                }
            });


            // --- Camera Functions ---
            async function startCamera() {
                if (currentStream) stopCamera();
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showStatus("Camera access not supported by this browser.", "error");
                    switchSection('start'); return;
                }
                const constraints = { video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false };
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (err) {
                    console.warn("Could not get rear camera or specific resolution, trying default camera:", err);
                    const fallbackConstraints = { video: true, audio: false };
                    try { currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints); }
                    catch (fallbackErr) { handleCameraError(fallbackErr); return; }
                }
                videoElement.srcObject = currentStream;
                await new Promise((resolve) => { videoElement.onloadedmetadata = () => resolve(); });
                await videoElement.play().catch(err => { console.error("Error playing video stream:", err); showStatus("Could not start camera display.", "error"); stopCamera(); switchSection('start'); });
                videoElement.addEventListener('playing', () => console.log("Camera stream started."), { once: true });
                 if (currentStream && currentStream.getVideoTracks().length > 0) {
                    currentStream.getVideoTracks()[0].addEventListener('ended', () => { console.warn("Camera stream ended unexpectedly."); showStatus("Camera disconnected.", "error"); stopCamera(); switchSection('start'); });
                }
            }
            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    videoElement.srcObject = null;
                    currentStream = null;
                    console.log("Camera stream stopped.");
                }
            }
            function captureImage() {
                if (!currentStream || videoElement.paused || videoElement.ended || !videoElement.videoWidth) {
                    showStatus("Camera not ready or stream ended.", "error");
                    capturedImageDataURL = null; return;
                }
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                const context = canvasElement.getContext('2d');
                if (!context) {
                    showStatus("Could not get canvas context.", "error");
                    capturedImageDataURL = null; return;
                }
                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                try {
                    capturedImageDataURL = canvasElement.toDataURL('image/jpeg', IMAGE_QUALITY);
                    imagePreview.src = capturedImageDataURL;
                    console.log(`Image captured (${canvasElement.width}x${canvasElement.height}, Quality: ${IMAGE_QUALITY}).`);
                } catch (e) {
                    console.error("Error converting canvas to data URL:", e);
                    showStatus("Error capturing image format.", "error");
                    capturedImageDataURL = null;
                }
            }


            // --- OCR Functions ---
            async function initializeOCRWorker() {
                if (!ocrWorker) {
                    showStatus("Initializing OCR engine...", "processing", 0);
                    try {
                        ocrWorker = await Tesseract.createWorker('eng', 1, {
                            logger: m => updateOCRProgress(m)
                        });
                        console.log("Tesseract worker initialized successfully.");
                    } catch (error) {
                        console.error("Error initializing Tesseract worker:", error);
                        showStatus("Failed to initialize OCR engine. Check network or browser compatibility.", "error", 8000);
                        ocrWorker = null;
                    }
                }
                return ocrWorker;
            }
            async function performOCR(imageDataUrl) {
                if (!imageDataUrl) return;
                const worker = await initializeOCRWorker();
                if (!worker) {
                    showStatus("OCR engine not available.", "error");
                    setReviewButtonsState(true);
                    return;
                }
                showStatus("Processing receipt...", "processing", 0);
                setReviewButtonsState(false);
                try {
                    const { data: { text } } = await worker.recognize(imageDataUrl);
                    if (!text || text.trim() === '') {
                        console.warn("OCR Result: No text detected.");
                        showStatus("Could not detect text on the receipt.", "error", 5000);
                        vendorInput.value = '';
                        amountInput.value = '';
                    } else {
                        console.log("OCR Result:", text.substring(0, 200) + "...");
                        showStatus("Analyzing extracted text...", "processing", 0);
                        parseOCRText(text);
                        showStatus("Review extracted details below.", "success", 5000);
                    }
                } catch (error) {
                    console.error("OCR Error:", error);
                    showStatus("Could not read text from image.", "error", 8000);
                } finally {
                    setReviewButtonsState(true);
                }
            }
            function updateOCRProgress(m) {
                console.log("OCR Progress:", m);
                let statusMsg = "Processing OCR...";
                if (m.status === "loading language model" && m.progress) {
                    statusMsg = `Loading language model... ${Math.round(m.progress * 100)}%`;
                    ocrProgressBar.style.width = `${Math.round(m.progress * 100)}%`;
                } else if (m.status === "recognizing text" && m.progress) {
                    statusMsg = `Recognizing text... ${Math.round(m.progress * 100)}%`;
                    ocrProgressBar.style.width = `${Math.round(m.progress * 100)}%`;
                } else if (m.status === "initializing api" || m.status === "initialized api"){
                    statusMsg = "Initializing OCR API...";
                    ocrProgressBar.style.width = '0%';
                } else if (m.status === "downloading") {
                    statusMsg = "Downloading OCR data...";
                    ocrProgressBar.style.width = '0%';
                }
                showStatus(statusMsg, "processing", 0);
            }
            function parseOCRText(text) {
                const lines = text.split('\n').filter(line => line.trim().length > 1);
                let vendor = "Unknown Vendor";
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine.match(/\d{1,2}[/-]\d{1,2}[/-]\d{2,4}/) && !trimmedLine.match(/^\d{1,4}\s+[A-Za-z]/) && !trimmedLine.match(/(\d{2}:\d{2})/) && trimmedLine.length > 2 && trimmedLine.length < 50) {
                        vendor = trimmedLine; break;
                    }
                }
                vendorInput.value = vendor;
                let dateFound = '';
                const datePatterns = [ /(\d{4})[-/](\d{1,2})[-/](\d{1,2})/, /(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})/, /(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s*,?\s*(\d{2,4})/i, /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{1,2}),?\s*(\d{2,4})/i ];
                for (const line of lines) {
                    for (const pattern of datePatterns) {
                        const match = line.match(pattern);
                        if (match) {
                            try {
                                let year, month, day;
                                if (pattern.source.includes('(\\d{4})')) { year = parseInt(match[1]); month = parseInt(match[2]) - 1; day = parseInt(match[3]); }
                                else if (pattern.source.includes('(\\d{2,4})')) { year = parseInt(match[3]); if (year < 100) year += 2000; if (isNaN(parseInt(match[1]))) { month = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'].indexOf(match[1].toLowerCase().substring(0,3)); day = parseInt(match[2]); } else { month = parseInt(match[1]) - 1; day = parseInt(match[2]); } }
                                if (year && month >= 0 && day) { const parsedDate = new Date(year, month, day); if (parsedDate.getFullYear() === year && parsedDate.getMonth() === month && parsedDate.getDate() === day) { dateFound = parsedDate.toISOString().split('T')[0]; break; } }
                            } catch (e) { console.warn("Date parsing error:", e); }
                        }
                    } if (dateFound) break;
                } dateInput.value = dateFound || new Date().toISOString().split('T')[0];
                let amount = '';
                const amountKeywords = ['Total', 'Amount', 'Balance', 'Due', 'Debit', 'Charge', 'Paid', 'Subtotal', 'S/Total', 'Total Due'];
                const amountRegex = /(?:[$£€]\s?|\b)(\d{1,3}(?:[,\s]\d{3})*(?:[.,]\d{2}))\b|\b(\d+[.,]\d{2})\b/;
                let potentialAmounts = [];
                for (let i = lines.length - 1; i >= 0; i--) {
                    const line = lines[i]; const match = line.match(amountRegex);
                    if (match) { const numberString = (match[1] || match[2]).replace(/[$,£€\s]/g, '').replace(',', '.'); const numericValue = parseFloat(numberString);
                        if (!isNaN(numericValue)) { let keywordProximity = -1; for (const keyword of amountKeywords) { const lowerLine = line.toLowerCase(); const nextLine = (i + 1 < lines.length) ? lines[i+1].toLowerCase() : ""; if (lowerLine.includes(keyword.toLowerCase())) { keywordProximity = 0; break; } if (nextLine.includes(keyword.toLowerCase())) { keywordProximity = 1; } } potentialAmounts.push({ value: numericValue, keywordProximity: keywordProximity }); } }
                } potentialAmounts.sort((a, b) => { if (a.keywordProximity !== -1 && b.keywordProximity === -1) return -1; if (a.keywordProximity === -1 && b.keywordProximity !== -1) return 1; if (a.keywordProximity !== -1 && b.keywordProximity !== -1) { if (a.keywordProximity !== b.keywordProximity) return a.keywordProximity - b.keywordProximity; } return b.value - a.value; });
                if (potentialAmounts.length > 0) { amount = potentialAmounts[0].value.toFixed(2); } amountInput.value = amount;
                console.log(`Parsed - Vendor: ${vendorInput.value}, Date: ${dateInput.value}, Amount: ${amountInput.value}`);
            }


            // --- UI Control Functions ---
            function switchSection(sectionName) {
                startSection.classList.remove('active-section', 'hidden-section'); scanSection.classList.remove('active-section', 'hidden-section'); reviewSection.classList.remove('active-section', 'hidden-section'); clearStatus();
                if (sectionName === 'start') startSection.classList.add('active-section'); else startSection.classList.add('hidden-section');
                if (sectionName === 'scan') scanSection.classList.add('active-section'); else scanSection.classList.add('hidden-section');
                if (sectionName === 'review') reviewSection.classList.add('active-section'); else reviewSection.classList.add('hidden-section');
                if (sectionName === 'scan') { captureBtn.disabled = false; cancelScanBtn.disabled = false; }
                if (sectionName === 'review') { setReviewButtonsState(true); }
            }
            function setReviewButtonsState(enabled) { saveBtn.disabled = !enabled; rescanBtn.disabled = !enabled; downloadBtn.disabled = !enabled; }
            function resetReviewState() { capturedImageDataURL = null; imagePreview.src = "#"; receiptForm.reset(); try { dateInput.value = new Date().toISOString().split('T')[0]; } catch(e){} clearStatus(); }
            function handleCameraError(error) { console.error("getUserMedia Error:", error.name, error.message); let message = "Could not access the camera."; if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') message = "Camera permission denied."; else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') message = "No camera found."; else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') message = "Camera is already in use."; else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') message = "Camera does not meet requirements."; else if (error.name === 'AbortError') message = "Camera access request aborted."; else if (error.name === 'SecurityError') message = "Camera access denied (security)."; showStatus(message, "error", 10000); switchSection('start'); }
            let statusTimeout;
            function showStatus(message, type = 'info', duration = 5000) { clearTimeout(statusTimeout); statusText.textContent = message; statusMessage.className = `status ${type} visible`; ocrProgressContainer.style.display = (type === 'processing') ? 'block' : 'none'; if(type !== 'processing') ocrProgressBar.style.width = '0%'; if (type !== 'processing' && duration > 0) { statusTimeout = setTimeout(clearStatus, duration); } }
            function clearStatus() { statusMessage.className = 'status'; ocrProgressContainer.style.display = 'none'; ocrProgressBar.style.width = '0%'; }

        }); // End DOMContentLoaded
    </script>
</body>
</html>
